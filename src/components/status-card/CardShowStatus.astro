---
import HolidayStatus from "./HolidayStatus.astro";
import NextHoliday from "./NextHoliday.astro";
import {actions} from "astro:actions";
import {getTodayDateChile} from "../../utils/dates/date";
import { isCacheValid, getCachedData, setCacheData } from "../../utils/cache/holidayCache";

const today = getTodayDateChile();

let data;
if (isCacheValid(today)) {
  data = getCachedData();
} else {
  const { data: actionData, error } = await Astro.callAction(actions.TodayIsHoliday, today);

  if (error) {
    console.log(error);
    throw new Error(error.message);
  }
  
  setCacheData(actionData, today);
  data = actionData;
}

const {isHoliday, holidays} = data;
const holidayIcon = isHoliday && holidays?.[0]?.icon ? holidays[0].icon : (isHoliday ? "üéâ" : "üìÖ");

---
<section class="my-8">
    <div
      class={`
        rounded-3xl px-4 py-4 sm:px-6 sm:py-6 flex flex-col gap-4
        border transition-all duration-300
        ${isHoliday
          ? "border-emerald-200/50 bg-gradient-to-br from-emerald-50/80 to-teal-50/80 shadow-sm shadow-emerald-100/50 hover:shadow-md hover:shadow-emerald-100"
          : "border-amber-200/50 bg-gradient-to-br from-amber-50/80 to-orange-50/80 shadow-sm shadow-amber-100/50 hover:shadow-md hover:shadow-amber-100"
        }
      `}
    >
        <!-- Header simplificado -->
        <div class="flex items-center gap-4">
            <div class={`
                flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 rounded-2xl
                ${isHoliday 
                    ? "bg-emerald-100/80 text-emerald-600" 
                    : "bg-amber-100/80 text-amber-600"
                }
            `}>
                <span class="text-2xl sm:text-3xl">{holidayIcon}</span>
            </div>
            <div class="flex-1">
                <h2 class={`text-base sm:text-xl font-bold
                    ${isHoliday ? "text-emerald-800" : "text-amber-800"}
                `}>
                    {isHoliday ? "Estado del d√≠a" : "Estado del d√≠a"}
                </h2>
                <p class={`text-xs sm:text-sm mt-0.5 ${isHoliday ? "text-emerald-600" : "text-amber-600"}`}>
                    {isHoliday ? "Disfruta tu d√≠a libre" : "Pr√≥ximo feriado"}
                </p>
            </div>
        </div>

        <!-- Contenido -->
        <div class="space-y-4">
            <div class={`
                rounded-2xl p-4 sm:p-5 transition-all duration-300
                ${isHoliday
                  ? "bg-white/70 border border-emerald-100/50 hover:bg-white/90"
                  : "bg-white/70 border border-amber-100/50 hover:bg-white/90"
                }
            `}>
                <HolidayStatus server:defer>
                    <div class="flex items-center gap-2 text-gray-500 text-sm">
                        <span class="text-lg">‚è≥</span>
                        <p>Verificando calendario...</p>
                    </div>
                </HolidayStatus>
            </div>

            <div class={`
                rounded-2xl p-4 sm:p-5 transition-all duration-300
                ${isHoliday
                  ? "bg-white/70 border border-emerald-100/50 hover:bg-white/90"
                  : "bg-white/70 border border-amber-100/50 hover:bg-white/90"
                }
            `}>
                <NextHoliday server:defer>
                    <div class="flex items-center gap-2 text-gray-500 text-sm">
                        <span class="text-lg">üîç</span>
                        <p>Buscando pr√≥ximo feriado...</p>
                    </div>
                </NextHoliday>
            </div>
        </div>
    </div>
</section>