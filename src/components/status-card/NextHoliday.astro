---
import { actions } from "astro:actions";
import { longDate, getTodayDateChile, getProgressPercentage, getDaysUntilHoliday } from "../../utils/dates/date";

const { data, error } = await Astro.callAction(
  actions.NextHoliday,
  getTodayDateChile(),
);

if (error) {
  console.log(error);
  throw new Error(error.message);
}

const { hasNextHoliday, nextHoliday, message } = data;
const daysRemaining = hasNextHoliday && nextHoliday && nextHoliday.date ? getDaysUntilHoliday(nextHoliday.date) : 0;
const progressPercentage = hasNextHoliday && nextHoliday && nextHoliday.date ? getProgressPercentage(nextHoliday.date) : 0;
---

<>
  {
    hasNextHoliday && nextHoliday ? (
      <div class="flex items-start gap-3 animate-in fade-in duration-500">
        <span class="text-3xl">{nextHoliday.icon || 'üéØ'}</span>
        <div class="flex-1">
          <p class="text-amber-700 font-bold text-lg">
            {nextHoliday.description}
          </p>
          <p class="text-amber-600 text-sm mt-1 flex items-center gap-2">
            <span>üìç</span>
            {longDate(nextHoliday?.date)}
          </p>
          <div class="mt-3 flex flex-col gap-2">
            <div class="flex items-center justify-between text-sm">
              <span class="text-amber-600">
                Faltan {daysRemaining} {daysRemaining === 1 ? 'd√≠a' : 'd√≠as'}
              </span>
              <span class="text-amber-600 font-semibold">
                {progressPercentage}%
              </span>
            </div>
            <div class="flex-1 h-1 bg-gradient-to-r from-amber-300 to-orange-300 rounded-full overflow-hidden">
              <div 
                class="h-full bg-gradient-to-r from-amber-500 to-orange-500 rounded-full transition-all duration-500" 
                style={`width: ${progressPercentage}%`}
              />
            </div>
          </div>
        </div>
      </div>
    ) : (
      <div class="flex items-start gap-3 text-amber-700">
        <span class="text-3xl">üåü</span>
        <p class="font-semibold">{message}</p>
      </div>
    )
  }
</>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(5px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  :global(.animate-in) {
    animation: fadeIn 0.5s ease-out;
  }
</style>